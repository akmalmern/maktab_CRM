generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  MANAGER
}

enum DocumentKind {
  PASSPORT
  CONTRACT
  CERTIFICATE
  DIPLOMA
  MEDICAL
  OTHER
}

enum HaftaKuni {
  DUSHANBA
  SESHANBA
  CHORSHANBA
  PAYSHANBA
  JUMA
  SHANBA
}

enum DavomatHolati {
  KELDI
  KECHIKDI
  SABABLI
  SABABSIZ
}

enum BahoTuri {
  JORIY
  NAZORAT
  ORALIQ
  YAKUNIY
}

enum TolovTuri {
  OYLIK
  YILLIK
  IXTIYORIY
}

enum TolovTranzaksiyaHolati {
  AKTIV
  BEKOR_QILINGAN
}

enum MoliyaTarifHolati {
  REJALANGAN
  AKTIV
  ARXIV
}

enum ImtiyozTuri {
  FOIZ
  SUMMA
  TOLIQ_OZOD
}

enum StudentOyMajburiyatHolati {
  BELGILANDI
  TOLANGAN
}

model User {
  id   String   @id @default(cuid())
  role UserRole

  username String @unique
  password String

  email String? @unique
  phone String? @unique

  isActive Boolean @default(true)

  admin   Admin?
  teacher Teacher?
  student Student?
  adminTolovTranzaksiyalari TolovTranzaksiya[] @relation("AdminTolovTranzaksiyalari")
  bekorQilganTolovTranzaksiyalari TolovTranzaksiya[] @relation("BekorQilganTolovTranzaksiyalari")
  adminTolovImtiyozlari TolovImtiyozi[] @relation("AdminTolovImtiyozlari")
  bekorQilinganTolovImtiyozlari TolovImtiyozi[] @relation("BekorQilinganTolovImtiyozlari")
  yaratganMoliyaTariflari MoliyaTarifVersion[] @relation("YaratganMoliyaTariflari")
  moliyaTarifAuditlari MoliyaTarifAudit[] @relation("MoliyaTarifAuditlari")
  managerQarzdorIzohlari QarzdorIzoh[] @relation("ManagerQarzdorIzohlari")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  avatarName String?
  avatarPath String?

  documents FileDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model Teacher {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  avatarName String?
  avatarPath String?

  documents FileDocument[]
  darsJadvallari DarsJadvali[]
  belgilaganDavomatlar Davomat[] @relation("TeacherBelgilaganDavomat")
  qoyganBaholar Baho[] @relation("TeacherQoyganBaholar")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
  @@index([subjectId])
}

model Student {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  parentPhone String?

  avatarName String?
  avatarPath String?

  documents FileDocument[]
  enrollments Enrollment[]
  davomatlar Davomat[]
  baholar Baho[]
  tolovTranzaksiyalari TolovTranzaksiya[]
  tolovQoplamalari TolovQoplama[]
  tolovImtiyozlari TolovImtiyozi[]
  qarzdorIzohlari QarzdorIzoh[]
  oyMajburiyatlari StudentOyMajburiyat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model FileDocument {
  id   String       @id @default(cuid())
  kind DocumentKind @default(OTHER)

  fileName String
  filePath String

  title     String?
  mimeType  String?
  sizeBytes Int?

  adminId   String?
  teacherId String?
  studentId String?

  admin   Admin?   @relation(fields: [adminId], references: [id], onDelete: Restrict)
  teacher Teacher? @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  student Student? @relation(fields: [studentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([teacherId])
  @@index([studentId])
}

model Subject {
  id   String @id @default(cuid())
  name String @unique

  teachers Teacher[]
  darsJadvallari DarsJadvali[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Classroom {
  id           String @id @default(cuid())
  name         String
  academicYear String
  isArchived   Boolean @default(false)

  enrollments Enrollment[]
  darsJadvallari DarsJadvali[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, academicYear])
  @@index([isArchived])
}

model Enrollment {
  id String @id @default(cuid())

  studentId   String
  classroomId String

  startDate DateTime @default(now())
  endDate   DateTime?
  isActive  Boolean  @default(true)

  student   Student   @relation(fields: [studentId], references: [id], onDelete: Restrict)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([classroomId])
  @@index([isActive])
}

model VaqtOraliq {
  id String @id @default(cuid())

  nomi            String
  boshlanishVaqti String
  tugashVaqti     String
  tartib          Int

  darsJadvallari DarsJadvali[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([boshlanishVaqti, tugashVaqti])
  @@unique([tartib])
}

model DarsJadvali {
  id String @id @default(cuid())

  sinfId       String
  oqituvchiId  String
  fanId        String
  haftaKuni    HaftaKuni
  vaqtOraliqId String
  oquvYili     String

  sinf       Classroom  @relation(fields: [sinfId], references: [id], onDelete: Restrict)
  oqituvchi  Teacher    @relation(fields: [oqituvchiId], references: [id], onDelete: Restrict)
  fan        Subject    @relation(fields: [fanId], references: [id], onDelete: Restrict)
  vaqtOraliq VaqtOraliq @relation(fields: [vaqtOraliqId], references: [id], onDelete: Restrict)
  davomatlar Davomat[]
  baholar    Baho[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sinfId])
  @@index([oqituvchiId])
  @@index([oqituvchiId, sinfId, haftaKuni])
  @@index([fanId])
  @@index([vaqtOraliqId])
  @@unique([sinfId, haftaKuni, vaqtOraliqId, oquvYili])
  @@unique([oqituvchiId, haftaKuni, vaqtOraliqId, oquvYili])
}

model Davomat {
  id String @id @default(cuid())

  darsJadvaliId String
  studentId String
  belgilaganTeacherId String

  sana DateTime
  holat DavomatHolati
  izoh String?

  darsJadvali DarsJadvali @relation(fields: [darsJadvaliId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  belgilaganTeacher Teacher @relation("TeacherBelgilaganDavomat", fields: [belgilaganTeacherId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sana])
  @@index([holat, sana])
  @@index([studentId, sana])
  @@index([belgilaganTeacherId, sana])
  @@index([darsJadvaliId, sana])
  @@unique([darsJadvaliId, studentId, sana])
}

model Baho {
  id String @id @default(cuid())

  darsJadvaliId String
  studentId String
  teacherId String
  sana DateTime

  turi BahoTuri
  ball Int
  maxBall Int
  izoh String?

  darsJadvali DarsJadvali @relation(fields: [darsJadvaliId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  teacher Teacher @relation("TeacherQoyganBaholar", fields: [teacherId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sana])
  @@index([studentId, sana])
  @@index([teacherId, sana])
  @@index([darsJadvaliId, sana])
  @@unique([darsJadvaliId, studentId, sana, turi])
}

model MoliyaSozlama {
  id String @id @default(cuid())
  key String @unique @default("MAIN")

  oylikSumma Int
  yillikSumma Int
  faolTarifId String?
  faolTarif MoliyaTarifVersion? @relation(fields: [faolTarifId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MoliyaTarifVersion {
  id String @id @default(cuid())

  oylikSumma Int
  yillikSumma Int

  boshlanishSana DateTime
  holat MoliyaTarifHolati @default(REJALANGAN)
  izoh String?

  yaratganAdminUserId String
  yaratganAdminUser User @relation("YaratganMoliyaTariflari", fields: [yaratganAdminUserId], references: [id], onDelete: Restrict)

  tolovTranzaksiyalari TolovTranzaksiya[]
  auditlar MoliyaTarifAudit[]
  faolSozlamalar MoliyaSozlama[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([holat, boshlanishSana])
  @@index([yaratganAdminUserId, createdAt])
}

model MoliyaTarifAudit {
  id String @id @default(cuid())

  action String
  oldValue Json?
  newValue Json?
  izoh String?

  tarifVersionId String?
  tarifVersion MoliyaTarifVersion? @relation(fields: [tarifVersionId], references: [id], onDelete: SetNull)

  performedByUserId String
  performedByUser User @relation("MoliyaTarifAuditlari", fields: [performedByUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action, createdAt])
  @@index([performedByUserId, createdAt])
}

model TolovTranzaksiya {
  id String @id @default(cuid())

  studentId String
  adminUserId String

  turi TolovTuri
  holat TolovTranzaksiyaHolati @default(AKTIV)
  summa Int
  tolovSana DateTime @default(now())
  izoh String?
  tarifSnapshot Json?
  tarifVersionId String?
  bekorSana DateTime?
  bekorIzoh String?
  bekorQilganAdminUserId String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  adminUser User @relation("AdminTolovTranzaksiyalari", fields: [adminUserId], references: [id], onDelete: Restrict)
  bekorQilganAdminUser User? @relation("BekorQilganTolovTranzaksiyalari", fields: [bekorQilganAdminUserId], references: [id], onDelete: Restrict)
  tarifVersion MoliyaTarifVersion? @relation(fields: [tarifVersionId], references: [id], onDelete: SetNull)
  qoplamalar TolovQoplama[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, tolovSana])
  @@index([adminUserId, tolovSana])
  @@index([holat, tolovSana])
  @@index([bekorQilganAdminUserId, bekorSana])
}

model TolovQoplama {
  id String @id @default(cuid())

  studentId String
  tranzaksiyaId String
  yil Int
  oy Int

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  tranzaksiya TolovTranzaksiya @relation(fields: [tranzaksiyaId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([studentId, yil, oy])
  @@index([tranzaksiyaId])
  @@unique([studentId, yil, oy])
}

model StudentOyMajburiyat {
  id String @id @default(cuid())

  studentId String
  yil Int
  oy Int

  bazaSumma Int
  imtiyozSumma Int @default(0)
  netSumma Int

  holat StudentOyMajburiyatHolati @default(BELGILANDI)
  source String @default("BAZA")

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, yil, oy])
  @@index([studentId, holat, yil, oy])
  @@index([holat, yil, oy])
}

model TolovImtiyozi {
  id String @id @default(cuid())

  studentId String
  adminUserId String

  turi ImtiyozTuri
  qiymat Int?
  boshlanishOy String
  oylarSoni Int
  oylarSnapshot Json?
  sabab String
  izoh String?
  isActive Boolean @default(true)
  bekorQilinganAt DateTime?
  bekorQilinganAdminUserId String?
  bekorQilishSababi String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  adminUser User @relation("AdminTolovImtiyozlari", fields: [adminUserId], references: [id], onDelete: Restrict)
  bekorQilinganAdminUser User? @relation("BekorQilinganTolovImtiyozlari", fields: [bekorQilinganAdminUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, isActive, createdAt])
  @@index([adminUserId, createdAt])
  @@index([bekorQilinganAdminUserId, bekorQilinganAt])
}

model QarzdorIzoh {
  id String @id @default(cuid())

  studentId String
  managerUserId String

  izoh String
  promisedPayDate DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  managerUser User @relation("ManagerQarzdorIzohlari", fields: [managerUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, createdAt])
  @@index([managerUserId, createdAt])
}
