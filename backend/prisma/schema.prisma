generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum UserRole {
  ADMIN
  TEACHER
  STUDENT
  MANAGER
}

enum DocumentKind {
  PASSPORT
  CONTRACT
  CERTIFICATE
  DIPLOMA
  MEDICAL
  OTHER
}

enum HaftaKuni {
  DUSHANBA
  SESHANBA
  CHORSHANBA
  PAYSHANBA
  JUMA
  SHANBA
}

enum DavomatHolati {
  KELDI
  KECHIKDI
  SABABLI
  SABABSIZ
}

enum BahoTuri {
  JORIY
  NAZORAT
  ORALIQ
  YAKUNIY
}

enum TolovTuri {
  OYLIK
  YILLIK
  IXTIYORIY
}

enum TolovTranzaksiyaHolati {
  AKTIV
  BEKOR_QILINGAN
}

enum MoliyaTarifHolati {
  REJALANGAN
  AKTIV
  ARXIV
}

enum ImtiyozTuri {
  FOIZ
  SUMMA
  TOLIQ_OZOD
}

enum StudentOyMajburiyatHolati {
  BELGILANDI
  QISMAN_TOLANGAN
  TOLANGAN
}

enum RealLessonStatus {
  DONE
  CANCELED
  REPLACED
}

enum PayrollRunStatus {
  DRAFT
  APPROVED
  PAID
  REVERSED
}

enum PayrollLineType {
  LESSON
  BONUS
  PENALTY
  MANUAL
}

enum PayrollPaymentMethod {
  CASH
  BANK
  CLICK
  PAYME
}

enum PayrollRateSource {
  TEACHER_RATE
  SUBJECT_DEFAULT_RATE
}

enum EmployeeKind {
  ADMIN
  MANAGER
  TEACHER
  STAFF
}

enum EmployeePayrollMode {
  LESSON_BASED
  FIXED
  MIXED
  MANUAL_ONLY
}

enum EmploymentStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

model User {
  id   String   @id @default(cuid())
  role UserRole

  username String @unique
  password String

  email String? @unique
  /// NOTE: `phone` Prisma-level optional because `User` is shared by ADMIN/TEACHER/STUDENT/MANAGER.
  /// DB-level role-specific CHECK constraint (custom SQL migration) enforces phone for TEACHER/STUDENT.
  phone String? @unique

  isActive Boolean @default(true)

  admin   Admin?
  teacher Teacher?
  student Student?
  employee Employee?
  adminTolovTranzaksiyalari TolovTranzaksiya[] @relation("AdminTolovTranzaksiyalari")
  bekorQilganTolovTranzaksiyalari TolovTranzaksiya[] @relation("BekorQilganTolovTranzaksiyalari")
  adminTolovImtiyozlari TolovImtiyozi[] @relation("AdminTolovImtiyozlari")
  bekorQilinganTolovImtiyozlari TolovImtiyozi[] @relation("BekorQilinganTolovImtiyozlari")
  yaratganMoliyaTariflari MoliyaTarifVersion[] @relation("YaratganMoliyaTariflari")
  moliyaTarifAuditlari MoliyaTarifAudit[] @relation("MoliyaTarifAuditlari")
  managerQarzdorIzohlari QarzdorIzoh[] @relation("ManagerQarzdorIzohlari")
  createdTeacherRates TeacherRate[] @relation("TeacherRateCreatedBy")
  createdSubjectDefaultRates SubjectDefaultRate[] @relation("SubjectDefaultRateCreatedBy")
  createdPayrollRuns PayrollRun[] @relation("PayrollRunCreatedBy")
  approvedPayrollRuns PayrollRun[] @relation("PayrollRunApprovedBy")
  paidPayrollRuns PayrollRun[] @relation("PayrollRunPaidBy")
  reversedPayrollRuns PayrollRun[] @relation("PayrollRunReversedBy")
  createdPayrollLines PayrollLine[] @relation("PayrollLineCreatedBy")
  payrollAuditLogs AuditLog[] @relation("AuditActorUser")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Admin {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  employeeId String? @unique
  employee Employee? @relation("AdminEmployee", fields: [employeeId], references: [id], onDelete: SetNull)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  avatarName String?
  avatarPath String?

  documents FileDocument[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model Teacher {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)
  employeeId String? @unique
  employee Employee? @relation("TeacherEmployee", fields: [employeeId], references: [id], onDelete: SetNull)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  subjectId String?
  subject   Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  avatarName String?
  avatarPath String?

  documents FileDocument[]
  darsJadvallari DarsJadvali[]
  belgilaganDavomatlar Davomat[] @relation("TeacherBelgilaganDavomat")
  qoyganBaholar Baho[] @relation("TeacherQoyganBaholar")
  realLessonsAsTeacher RealLesson[] @relation("RealLessonTeacher")
  realLessonsAsReplacement RealLesson[] @relation("RealLessonReplacedByTeacher")
  teacherRates TeacherRate[]
  payrollItems PayrollItem[]
  payrollLines PayrollLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
  @@index([subjectId])
}

model Student {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Restrict)

  firstName      String
  lastName       String
  birthDate      DateTime?
  yashashManzili String?

  /// NOTE: DB-level CHECK constraint (custom SQL migration) enforces non-empty `parentPhone`.
  parentPhone String?

  avatarName String?
  avatarPath String?

  documents FileDocument[]
  enrollments Enrollment[]
  davomatlar Davomat[]
  baholar Baho[]
  tolovTranzaksiyalari TolovTranzaksiya[]
  tolovQoplamalari TolovQoplama[]
  tolovImtiyozlari TolovImtiyozi[]
  qarzdorIzohlari QarzdorIzoh[]
  oyMajburiyatlari StudentOyMajburiyat[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([firstName, lastName, birthDate])
}

model FileDocument {
  id   String       @id @default(cuid())
  kind DocumentKind @default(OTHER)

  fileName String
  filePath String

  title     String?
  mimeType  String?
  sizeBytes Int?

  adminId   String?
  teacherId String?
  studentId String?

  admin   Admin?   @relation(fields: [adminId], references: [id], onDelete: Restrict)
  teacher Teacher? @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  student Student? @relation(fields: [studentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([adminId])
  @@index([teacherId])
  @@index([studentId])
}

model Subject {
  id   String @id @default(cuid())
  name String @unique

  teachers Teacher[]
  darsJadvallari DarsJadvali[]
  realLessons RealLesson[]
  teacherRates TeacherRate[]
  subjectDefaultRates SubjectDefaultRate[]
  payrollLines PayrollLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Classroom {
  id           String @id @default(cuid())
  name         String
  academicYear String
  isArchived   Boolean @default(false)

  enrollments Enrollment[]
  darsJadvallari DarsJadvali[]
  realLessons RealLesson[]
  payrollLines PayrollLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, academicYear])
  @@index([isArchived])
}

model Enrollment {
  id String @id @default(cuid())

  studentId   String
  classroomId String

  startDate DateTime @default(now())
  endDate   DateTime?
  isActive  Boolean  @default(true)

  student   Student   @relation(fields: [studentId], references: [id], onDelete: Restrict)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId])
  @@index([classroomId])
  @@index([isActive])
}

model VaqtOraliq {
  id String @id @default(cuid())

  nomi            String
  boshlanishVaqti String
  tugashVaqti     String
  tartib          Int

  darsJadvallari DarsJadvali[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([boshlanishVaqti, tugashVaqti])
  @@unique([tartib])
}

model DarsJadvali {
  id String @id @default(cuid())

  sinfId       String
  oqituvchiId  String
  fanId        String
  haftaKuni    HaftaKuni
  vaqtOraliqId String
  oquvYili     String

  sinf       Classroom  @relation(fields: [sinfId], references: [id], onDelete: Restrict)
  oqituvchi  Teacher    @relation(fields: [oqituvchiId], references: [id], onDelete: Restrict)
  fan        Subject    @relation(fields: [fanId], references: [id], onDelete: Restrict)
  vaqtOraliq VaqtOraliq @relation(fields: [vaqtOraliqId], references: [id], onDelete: Restrict)
  davomatlar Davomat[]
  baholar    Baho[]
  realLessons RealLesson[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sinfId])
  @@index([oqituvchiId])
  @@index([oqituvchiId, sinfId, haftaKuni])
  @@index([fanId])
  @@index([vaqtOraliqId])
  @@unique([sinfId, haftaKuni, vaqtOraliqId, oquvYili])
  @@unique([oqituvchiId, haftaKuni, vaqtOraliqId, oquvYili])
}

model Davomat {
  id String @id @default(cuid())

  darsJadvaliId String
  studentId String
  belgilaganTeacherId String

  sana DateTime
  holat DavomatHolati
  izoh String?

  darsJadvali DarsJadvali @relation(fields: [darsJadvaliId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  belgilaganTeacher Teacher @relation("TeacherBelgilaganDavomat", fields: [belgilaganTeacherId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sana])
  @@index([holat, sana])
  @@index([studentId, sana])
  @@index([belgilaganTeacherId, sana])
  @@index([darsJadvaliId, sana])
  @@unique([darsJadvaliId, studentId, sana])
}

model Baho {
  id String @id @default(cuid())

  darsJadvaliId String
  studentId String
  teacherId String
  sana DateTime

  turi BahoTuri
  ball Int
  maxBall Int
  izoh String?

  darsJadvali DarsJadvali @relation(fields: [darsJadvaliId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  teacher Teacher @relation("TeacherQoyganBaholar", fields: [teacherId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([sana])
  @@index([studentId, sana])
  @@index([teacherId, sana])
  @@index([darsJadvaliId, sana])
  @@unique([darsJadvaliId, studentId, sana, turi])
}

model Organization {
  id   String @id @default(cuid())
  key  String @unique
  name String

  employees           Employee[]
  realLessons         RealLesson[]
  teacherRates        TeacherRate[]
  subjectDefaultRates SubjectDefaultRate[]
  payrollRuns         PayrollRun[]
  payrollItems        PayrollItem[]
  payrollLines        PayrollLine[]
  auditLogs           AuditLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id String @id @default(cuid())

  organizationId String
  userId String @unique

  kind EmployeeKind
  payrollMode EmployeePayrollMode @default(MANUAL_ONLY)
  employmentStatus EmploymentStatus @default(ACTIVE)
  isPayrollEligible Boolean @default(true)

  firstName String?
  lastName String?
  hireDate DateTime?
  terminationDate DateTime?

  bankName String?
  bankAccount String?
  cardNumber String?

  note String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  user User @relation(fields: [userId], references: [id], onDelete: Restrict)

  teacher Teacher? @relation("TeacherEmployee")
  admin Admin? @relation("AdminEmployee")

  payrollItems PayrollItem[]
  payrollLines PayrollLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, kind, employmentStatus])
  @@index([organizationId, isPayrollEligible])
  @@index([organizationId, payrollMode])
}

model RealLesson {
  id String @id @default(cuid())

  organizationId String
  teacherId String
  subjectId String
  classroomId String
  darsJadvaliId String?

  startAt DateTime
  endAt DateTime
  durationMinutes Int

  status RealLessonStatus @default(DONE)
  replacedByTeacherId String?
  note String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  teacher Teacher @relation("RealLessonTeacher", fields: [teacherId], references: [id], onDelete: Restrict)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  classroom Classroom @relation(fields: [classroomId], references: [id], onDelete: Restrict)
  darsJadvali DarsJadvali? @relation(fields: [darsJadvaliId], references: [id], onDelete: SetNull)
  replacedByTeacher Teacher? @relation("RealLessonReplacedByTeacher", fields: [replacedByTeacherId], references: [id], onDelete: SetNull)
  payrollLines PayrollLine[] @relation("PayrollLineRealLesson")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, startAt])
  @@index([organizationId, status, startAt])
  @@index([teacherId, startAt])
  @@index([subjectId, startAt])
  @@index([classroomId, startAt])
  @@index([replacedByTeacherId, startAt])
  @@index([darsJadvaliId])
}

model TeacherRate {
  id String @id @default(cuid())

  organizationId String
  teacherId String
  subjectId String

  ratePerHour Decimal @db.Decimal(14, 2)
  currencyCode String @default("UZS")

  effectiveFrom DateTime
  effectiveTo DateTime?
  note String?

  createdByUserId String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  teacher Teacher @relation(fields: [teacherId], references: [id], onDelete: Restrict)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  createdByUser User? @relation("TeacherRateCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  payrollLines PayrollLine[] @relation("PayrollLineTeacherRate")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, teacherId, subjectId, effectiveFrom])
  @@index([organizationId, teacherId, subjectId, effectiveTo])
}

model SubjectDefaultRate {
  id String @id @default(cuid())

  organizationId String
  subjectId String

  ratePerHour Decimal @db.Decimal(14, 2)
  currencyCode String @default("UZS")

  effectiveFrom DateTime
  effectiveTo DateTime?
  note String?

  createdByUserId String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Restrict)
  createdByUser User? @relation("SubjectDefaultRateCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)
  payrollLines PayrollLine[] @relation("PayrollLineSubjectDefaultRate")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, subjectId, effectiveFrom])
  @@index([organizationId, subjectId, effectiveTo])
}

model PayrollRun {
  id String @id @default(cuid())

  organizationId String
  periodMonth String
  periodStart DateTime
  periodEnd DateTime
  timezone String @default("Asia/Tashkent")

  status PayrollRunStatus @default(DRAFT)
  calcVersion Int @default(1)

  generatedAt DateTime?
  approvedAt DateTime?
  paidAt DateTime?
  reversedAt DateTime?

  createdByUserId String
  approvedByUserId String?
  paidByUserId String?
  reversedByUserId String?

  paymentMethod PayrollPaymentMethod?
  externalRef String?
  paymentNote String?
  reverseReason String?

  sourceLessonsCount Int @default(0)
  teacherCount Int @default(0)
  grossAmount Decimal @default(0) @db.Decimal(14, 2)
  adjustmentAmount Decimal @default(0) @db.Decimal(14, 2)
  payableAmount Decimal @default(0) @db.Decimal(14, 2)

  generationSummary Json?
  meta Json?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  createdByUser User @relation("PayrollRunCreatedBy", fields: [createdByUserId], references: [id], onDelete: Restrict)
  approvedByUser User? @relation("PayrollRunApprovedBy", fields: [approvedByUserId], references: [id], onDelete: Restrict)
  paidByUser User? @relation("PayrollRunPaidBy", fields: [paidByUserId], references: [id], onDelete: Restrict)
  reversedByUser User? @relation("PayrollRunReversedBy", fields: [reversedByUserId], references: [id], onDelete: Restrict)

  items PayrollItem[]
  lines PayrollLine[]
  auditLogs AuditLog[] @relation("AuditLogPayrollRun")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([organizationId, periodMonth])
  @@index([organizationId, status, periodStart])
  @@index([status, createdAt])
}

model PayrollItem {
  id String @id @default(cuid())

  organizationId String
  payrollRunId String
  employeeId String?
  teacherId String?

  totalMinutes Int @default(0)
  totalHours Decimal @default(0) @db.Decimal(14, 2)

  grossAmount Decimal @default(0) @db.Decimal(14, 2)
  bonusAmount Decimal @default(0) @db.Decimal(14, 2)
  penaltyAmount Decimal @default(0) @db.Decimal(14, 2)
  manualAmount Decimal @default(0) @db.Decimal(14, 2)
  adjustmentAmount Decimal @default(0) @db.Decimal(14, 2)
  payableAmount Decimal @default(0) @db.Decimal(14, 2)

  lessonLineCount Int @default(0)
  lineCount Int @default(0)

  teacherFirstNameSnapshot String?
  teacherLastNameSnapshot String?
  teacherUsernameSnapshot String?
  summarySnapshot Json?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  payrollRun PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  teacher Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)

  lines PayrollLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([payrollRunId, employeeId])
  @@unique([payrollRunId, teacherId])
  @@index([organizationId, payrollRunId])
  @@index([organizationId, employeeId, createdAt])
  @@index([organizationId, teacherId, createdAt])
}

model PayrollLine {
  id String @id @default(cuid())

  organizationId String
  payrollRunId String
  payrollItemId String
  employeeId String?
  teacherId String?

  type PayrollLineType

  realLessonId String?
  subjectId String?
  classroomId String?
  lessonStartAt DateTime?
  minutes Int?
  ratePerHour Decimal? @db.Decimal(14, 2)

  amount Decimal @db.Decimal(14, 2)

  rateSource PayrollRateSource?
  teacherRateId String?
  subjectDefaultRateId String?

  description String?
  meta Json?

  createdByUserId String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  payrollRun PayrollRun @relation(fields: [payrollRunId], references: [id], onDelete: Cascade)
  payrollItem PayrollItem @relation(fields: [payrollItemId], references: [id], onDelete: Cascade)
  employee Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  teacher Teacher? @relation(fields: [teacherId], references: [id], onDelete: SetNull)
  subject Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)
  classroom Classroom? @relation(fields: [classroomId], references: [id], onDelete: SetNull)
  realLesson RealLesson? @relation("PayrollLineRealLesson", fields: [realLessonId], references: [id], onDelete: SetNull)
  teacherRate TeacherRate? @relation("PayrollLineTeacherRate", fields: [teacherRateId], references: [id], onDelete: SetNull)
  subjectDefaultRate SubjectDefaultRate? @relation("PayrollLineSubjectDefaultRate", fields: [subjectDefaultRateId], references: [id], onDelete: SetNull)
  createdByUser User? @relation("PayrollLineCreatedBy", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([payrollRunId, realLessonId])
  @@index([organizationId, payrollRunId, employeeId])
  @@index([organizationId, payrollRunId, teacherId])
  @@index([payrollItemId, type])
  @@index([realLessonId])
  @@index([type, createdAt])
}

model AuditLog {
  id String @id @default(cuid())

  organizationId String
  actorUserId String?

  action String
  entityType String
  entityId String
  payrollRunId String?

  before Json?
  after Json?

  reason String?
  ip String?
  userAgent String?

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Restrict)
  actorUser User? @relation("AuditActorUser", fields: [actorUserId], references: [id], onDelete: SetNull)
  payrollRun PayrollRun? @relation("AuditLogPayrollRun", fields: [payrollRunId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())

  @@index([organizationId, createdAt])
  @@index([entityType, entityId, createdAt])
  @@index([actorUserId, createdAt])
  @@index([payrollRunId, createdAt])
}

model MoliyaSozlama {
  id String @id @default(cuid())
  key String @unique @default("MAIN")

  oylikSumma Int
  yillikSumma Int
  tolovOylarSoni Int @default(10)
  billingCalendar Json?
  faolTarifId String?
  faolTarif MoliyaTarifVersion? @relation(fields: [faolTarifId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MoliyaTarifVersion {
  id String @id @default(cuid())

  oylikSumma Int
  yillikSumma Int
  tolovOylarSoni Int @default(10)
  billingCalendar Json?

  boshlanishSana DateTime
  holat MoliyaTarifHolati @default(REJALANGAN)
  izoh String?

  yaratganAdminUserId String
  yaratganAdminUser User @relation("YaratganMoliyaTariflari", fields: [yaratganAdminUserId], references: [id], onDelete: Restrict)

  tolovTranzaksiyalari TolovTranzaksiya[]
  auditlar MoliyaTarifAudit[]
  faolSozlamalar MoliyaSozlama[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([holat, boshlanishSana])
  @@index([yaratganAdminUserId, createdAt])
}

model MoliyaTarifAudit {
  id String @id @default(cuid())

  action String
  oldValue Json?
  newValue Json?
  izoh String?

  tarifVersionId String?
  tarifVersion MoliyaTarifVersion? @relation(fields: [tarifVersionId], references: [id], onDelete: SetNull)

  performedByUserId String
  performedByUser User @relation("MoliyaTarifAuditlari", fields: [performedByUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([action, createdAt])
  @@index([performedByUserId, createdAt])
}

model TolovTranzaksiya {
  id String @id @default(cuid())

  studentId String
  adminUserId String

  turi TolovTuri
  holat TolovTranzaksiyaHolati @default(AKTIV)
  summa Int
  tolovSana DateTime @default(now())
  izoh String?
  idempotencyKey String?
  tarifSnapshot Json?
  tarifVersionId String?
  bekorSana DateTime?
  bekorIzoh String?
  bekorQilganAdminUserId String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  adminUser User @relation("AdminTolovTranzaksiyalari", fields: [adminUserId], references: [id], onDelete: Restrict)
  bekorQilganAdminUser User? @relation("BekorQilganTolovTranzaksiyalari", fields: [bekorQilganAdminUserId], references: [id], onDelete: Restrict)
  tarifVersion MoliyaTarifVersion? @relation(fields: [tarifVersionId], references: [id], onDelete: SetNull)
  qoplamalar TolovQoplama[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, tolovSana])
  @@index([adminUserId, tolovSana])
  @@index([holat, tolovSana])
  @@index([bekorQilganAdminUserId, bekorSana])
  @@unique([studentId, idempotencyKey])
}

model TolovQoplama {
  id String @id @default(cuid())

  studentId String
  tranzaksiyaId String
  yil Int
  oy Int
  summa Int @default(0)

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  tranzaksiya TolovTranzaksiya @relation(fields: [tranzaksiyaId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([studentId, yil, oy])
  @@index([tranzaksiyaId])
  @@unique([tranzaksiyaId, yil, oy])
}

model StudentOyMajburiyat {
  id String @id @default(cuid())

  studentId String
  yil Int
  oy Int

  bazaSumma Int
  imtiyozSumma Int @default(0)
  netSumma Int
  tolanganSumma Int @default(0)
  qoldiqSumma Int @default(0)

  holat StudentOyMajburiyatHolati @default(BELGILANDI)
  source String @default("BAZA")

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([studentId, yil, oy])
  @@index([studentId, holat, yil, oy])
  @@index([holat, yil, oy])
}

model TolovImtiyozi {
  id String @id @default(cuid())

  studentId String
  adminUserId String

  turi ImtiyozTuri
  qiymat Int?
  boshlanishYil Int
  boshlanishOyRaqam Int
  oylarSoni Int
  oylarSnapshot Json?
  sabab String
  izoh String?
  isActive Boolean @default(true)
  bekorQilinganAt DateTime?
  bekorQilinganAdminUserId String?
  bekorQilishSababi String?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  adminUser User @relation("AdminTolovImtiyozlari", fields: [adminUserId], references: [id], onDelete: Restrict)
  bekorQilinganAdminUser User? @relation("BekorQilinganTolovImtiyozlari", fields: [bekorQilinganAdminUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, isActive, createdAt])
  @@index([studentId, isActive, boshlanishYil, boshlanishOyRaqam])
  @@index([adminUserId, createdAt])
  @@index([bekorQilinganAdminUserId, bekorQilinganAt])
}

model QarzdorIzoh {
  id String @id @default(cuid())

  studentId String
  managerUserId String

  izoh String
  promisedPayDate DateTime?

  student Student @relation(fields: [studentId], references: [id], onDelete: Restrict)
  managerUser User @relation("ManagerQarzdorIzohlari", fields: [managerUserId], references: [id], onDelete: Restrict)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, createdAt])
  @@index([managerUserId, createdAt])
}
